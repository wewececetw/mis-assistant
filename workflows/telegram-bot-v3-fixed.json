{
  "name": "Telegram Bot V3",
  "nodes": [
    {"parameters":{"updates":["message"]},"id":"tg","name":"Telegram","type":"n8n-nodes-base.telegramTrigger","typeVersion":1.1,"position":[240,400],"webhookId":"tg-v3","credentials":{"telegramApi":{"id":"XfuqkzOYYEa0ar0n","name":"Telegram Bot"}}},
    {"parameters":{"jsCode":"const msg=$input.first().json.message;const chatId=msg?.chat?.id||'';const text=msg?.text?.trim()||'';const voice=msg?.voice||msg?.audio;const voiceFileId=voice?.file_id||'';let action='unknown';if(voiceFileId){action='voice';return[{json:{action,chatId,voiceFileId}}]}if(text.startsWith('/')){action=text.substring(1).split(/[@\\s]/)[0].toLowerCase()}const r={start:'ðŸ¤– MIS\\n\\n/status /backup /news /meeting\\n\\nðŸŽ¤èªžéŸ³=AIè¨˜éŒ„',meeting:'ðŸ“ æœƒè­°\\n\\nðŸŽ¤ç›´æŽ¥ç™¼èªžéŸ³',help:'â“ /help',unknown:'âŒ æœªçŸ¥'};if(r[action]){return[{json:{action:'reply',chatId,message:r[action]}}]}return[{json:{action,chatId,text}}]"},"id":"router","name":"Router","type":"n8n-nodes-base.code","typeVersion":2,"position":[460,400]},
    {"parameters":{"conditions":{"conditions":[{"leftValue":"={{$json.action}}","rightValue":"reply"}]}},"id":"is-reply","name":"Reply?","type":"n8n-nodes-base.if","typeVersion":2,"position":[680,400]},
    {"parameters":{"chatId":"={{$json.chatId}}","text":"={{$json.message}}"},"id":"send","name":"Send","type":"n8n-nodes-base.telegram","typeVersion":1.1,"position":[900,300],"credentials":{"telegramApi":{"id":"XfuqkzOYYEa0ar0n","name":"Telegram Bot"}}},
    {"parameters":{"conditions":{"conditions":[{"leftValue":"={{$json.action}}","rightValue":"voice"}]}},"id":"is-voice","name":"Voice?","type":"n8n-nodes-base.if","typeVersion":2,"position":[900,500]},
    {"parameters":{"chatId":"={{$json.chatId}}","text":"ðŸŽ¤ è™•ç†ä¸­\\nâ³ 20-40s\\n1.å£“ç¸® 2.è½‰æ–‡å­— 3.AIæ‘˜è¦"},"id":"ack","name":"Ack","type":"n8n-nodes-base.telegram","typeVersion":1.1,"position":[1120,500],"credentials":{"telegramApi":{"id":"XfuqkzOYYEa0ar0n","name":"Telegram Bot"}}},
    {"parameters":{"url":"=https://api.telegram.org/bot{{$env.TELEGRAM_BOT_TOKEN}}/getFile?file_id={{$('Router').first().json.voiceFileId}}"},"id":"getfile","name":"GetFile","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1340,500]},
    {"parameters":{"url":"=https://api.telegram.org/file/bot{{$env.TELEGRAM_BOT_TOKEN}}/{{$json.result.file_path}}","options":{"response":{"response":{"responseFormat":"file"}}}},"id":"dl","name":"DL","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1560,500]},
    {"parameters":{"fileName":"/tmp/vin.oga"},"id":"save","name":"Save","type":"n8n-nodes-base.writeBinaryFile","typeVersion":1,"position":[1780,500]},
    {"parameters":{"jsCode":"const fs=require('fs');const{execSync}=require('child_process');try{execSync('ffmpeg -y -i /tmp/vin.oga -ar 16000 -ac 1 -b:a 32k /tmp/vout.mp3 2>&1');const buf=fs.readFileSync('/tmp/vout.mp3');return[{json:{},binary:{data:buf}}]}catch(e){throw new Error('FFmpeg failed: '+e.message)}"},"id":"compress","name":"Compress","type":"n8n-nodes-base.code","typeVersion":2,"position":[2000,500]},
    {"parameters":{"method":"POST","url":"https://api.groq.com/openai/v1/audio/transcriptions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"contentType":"multipart-form-data","bodyParameters":{"parameters":[{"name":"file","parameterType":"formBinaryData","inputDataFieldName":"data"},{"name":"model","value":"whisper-large-v3"},{"name":"language","value":"zh"}]}},"id":"whisper","name":"Whisper","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2220,500],"credentials":{"httpHeaderAuth":{"id":"06uVsarrbPv5XTZf","name":"Groq API"}}},
    {"parameters":{"jsCode":"const text=$input.first().json?.text||'';if(!text||text.length<5)return[{json:{ok:false}}];const p='åˆ†æžèªžéŸ³è½‰æ–‡å­—ï¼Œç¹ä¸­æ‘˜è¦ï¼š\\n\\nðŸ“Œä¸»é¡Œ\\nðŸ“‹é‡é»žï¼ˆ2-3é»žï¼‰\\nâœ…æ±ºè­°\\nðŸ“å¾…è¾¦\\n\\nå…§å®¹ï¼š'+text;return[{json:{ok:true,text,prompt:p}}]"},"id":"prep","name":"Prep","type":"n8n-nodes-base.code","typeVersion":2,"position":[2440,500]},
    {"parameters":{"conditions":{"conditions":[{"leftValue":"={{$json.ok}}","rightValue":true,"operator":{"type":"boolean","operation":"equals"}}]}},"id":"check","name":"OK?","type":"n8n-nodes-base.if","typeVersion":2,"position":[2660,500]},
    {"parameters":{"method":"POST","url":"https://api.groq.com/openai/v1/chat/completions","authentication":"genericCredentialType","genericAuthType":"httpHeaderAuth","sendBody":true,"specifyBody":"json","jsonBody":"={{JSON.stringify({model:'llama-3.3-70b-versatile',messages:[{role:'user',content:$json.prompt}],temperature:0.3,max_tokens:1000})}}"},"id":"ai","name":"AI","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2880,440],"credentials":{"httpHeaderAuth":{"id":"06uVsarrbPv5XTZf","name":"Groq API"}}},
    {"parameters":{"jsCode":"const chatId=$('Router').first().json.chatId;const text=$('Prep').first().json.text;let s=$input.first().json?.choices?.[0]?.message?.content||'å¤±æ•—';s=s.replace(/\\*\\*/g,'').replace(/\\*/g,'â€¢');const msg='ðŸ¤– AIæœƒè­°è¨˜éŒ„\\nâ”â”â”â”â”â”â”â”\\n\\n'+s+'\\n\\nâ”â”â”â”â”â”â”â”\\nðŸ“åŽŸæ–‡ï¼š'+text.substring(0,60)+'...';return[{json:{message:msg,chatId}}]"},"id":"fmt","name":"Fmt","type":"n8n-nodes-base.code","typeVersion":2,"position":[3100,440]},
    {"parameters":{"chatId":"={{$json.chatId}}","text":"={{$json.message}}"},"id":"send-ok","name":"SendOK","type":"n8n-nodes-base.telegram","typeVersion":1.1,"position":[3320,440],"credentials":{"telegramApi":{"id":"XfuqkzOYYEa0ar0n","name":"Telegram Bot"}}},
    {"parameters":{"jsCode":"const chatId=$('Router').first().json.chatId;return[{json:{message:'âŒ å¤±æ•—\\nè«‹é‡éŒ„æ¸…æ™°èªžéŸ³',chatId}}]"},"id":"err","name":"Err","type":"n8n-nodes-base.code","typeVersion":2,"position":[2880,560]},
    {"parameters":{"chatId":"={{$json.chatId}}","text":"={{$json.message}}"},"id":"send-err","name":"SendErr","type":"n8n-nodes-base.telegram","typeVersion":1.1,"position":[3100,560],"credentials":{"telegramApi":{"id":"XfuqkzOYYEa0ar0n","name":"Telegram Bot"}}}
  ],
  "connections":{
    "Telegram":{"main":[[{"node":"Router"}]]},
    "Router":{"main":[[{"node":"Reply?"}]]},
    "Reply?":{"main":[[{"node":"Send"}],[{"node":"Voice?"}]]},
    "Voice?":{"main":[[{"node":"Ack"}],[]]},
    "Ack":{"main":[[{"node":"GetFile"}]]},
    "GetFile":{"main":[[{"node":"DL"}]]},
    "DL":{"main":[[{"node":"Save"}]]},
    "Save":{"main":[[{"node":"Compress"}]]},
    "Compress":{"main":[[{"node":"Whisper"}]]},
    "Whisper":{"main":[[{"node":"Prep"}]]},
    "Prep":{"main":[[{"node":"OK?"}]]},
    "OK?":{"main":[[{"node":"AI"}],[{"node":"Err"}]]},
    "AI":{"main":[[{"node":"Fmt"}]]},
    "Fmt":{"main":[[{"node":"SendOK"}]]},
    "Err":{"main":[[{"node":"SendErr"}]]}
  },
  "settings":{"executionOrder":"v1"}
}
